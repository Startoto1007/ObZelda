// Variables globales
let currentPart = 1;
let selectedTimeSlots = new Set();

// Attendre que le DOM soit complètement chargé
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    initializeNavigation();
    initializeForm();
});

// Initialisation du calendrier
function initializeCalendar() {
    const calendarGrid = document.getElementById('calendar-grid');
    const days = ['Heure', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    
    // Créer les en-têtes
    days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        calendarGrid.appendChild(header);
    });
    
    // Créer les créneaux horaires (6h à 24h par tranches de 30min)
    for (let hour = 6; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // Cellule de l'heure
            const timeCell = document.createElement('div');
            timeCell.className = 'time-slot';
            timeCell.textContent = timeString;
            calendarGrid.appendChild(timeCell);
            
            // Cellules pour chaque jour
            for (let day = 1; day <= 7; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.dataset.day = day;
                cell.dataset.time = timeString;
                cell.dataset.slot = `${day}-${timeString}`;
                
                cell.addEventListener('click', function() {
                    toggleTimeSlot(this);
                });
                
                calendarGrid.appendChild(cell);
            }
        }
    }
}

// Basculer la sélection d'un créneau
function toggleTimeSlot(cell) {
    const slot = cell.dataset.slot;
    
    if (selectedTimeSlots.has(slot)) {
        selectedTimeSlots.delete(slot);
        cell.classList.remove('selected');
    } else {
        selectedTimeSlots.add(slot);
        cell.classList.add('selected');
    }
    
    updateCalendarSummary();
}

// Mettre à jour le résumé du calendrier
function updateCalendarSummary() {
    const summaryText = document.getElementById('summary-text');
    const hiddenInput = document.getElementById('temps-jeu');
    
    if (selectedTimeSlots.size === 0) {
        summaryText.textContent = 'Aucun créneau sélectionné';
        hiddenInput.value = '';
        return;
    }
    
    // Organiser par jour
    const dayNames = ['', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
    const schedule = {};
    
    selectedTimeSlots.forEach(slot => {
        const [day, time] = slot.split('-');
        const dayName = dayNames[parseInt(day)];
        
        if (!schedule[dayName]) {
            schedule[dayName] = [];
        }
        schedule[dayName].push(time);
    });
    
    // Créer le texte de résumé
    let summaryHTML = '';
    let summaryText_value = '';
    
    Object.keys(schedule).forEach(day => {
        const times = schedule[day].sort();
        const ranges = consolidateTimeRanges(times);
        summaryHTML += `<p><strong>${day}:</strong> ${ranges.join(', ')}</p>`;
        summaryText_value += `${day}: ${ranges.join(', ')}; `;
    });
    
    summaryText.innerHTML = summaryHTML;
    hiddenInput.value = summaryText_value.trim();
}

// Consolider les créneaux en plages horaires
function consolidateTimeRanges(times) {
    if (times.length === 0) return [];
    
    const ranges = [];
    let start = times[0];
    let end = times[0];
    
    for (let i = 1; i < times.length; i++) {
        const currentTime = times[i];
        const endTime = new Date(`2000-01-01 ${end}`);
        const currentTimeObj = new Date(`2000-01-01 ${currentTime}`);
        
        // Vérifier si c'est consécutif (30 min d'écart)
        if (currentTimeObj.getTime() - endTime.getTime() === 30 * 60 * 1000) {
            end = currentTime;
        } else {
            // Ajouter la plage précédente
            if (start === end) {
                ranges.push(start);
            } else {
                ranges.push(`${start}-${end}`);
            }
            start = currentTime;
            end = currentTime;
        }
    }
    
    // Ajouter la dernière plage
    if (start === end) {
        ranges.push(start);
    } else {
        ranges.push(`${start}-${end}`);
    }
    
    return ranges;
}

// Initialisation de la navigation
function initializeNavigation() {
    const nextBtn = document.getElementById('next-btn');
    const prevBtn2 = document.getElementById('prev-btn-2');
    const submitBtn = document.getElementById('submit-btn');
    
    // Bouton suivant (partie 1 → partie 2)
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            if (validatePart1()) {
                showPart(2);
            }
        });
    }
    
    // Bouton précédent (partie 2 → partie 1)
    if (prevBtn2) {
        prevBtn2.addEventListener('click', function() {
            showPart(1);
        });
    }
    
    // Bouton de soumission
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            if (validatePart2()) {
                submitForm();
            }
        });
    }
}

// Validation de la partie 1
function validatePart1() {
    const requiredFields = [
        'pseudo-mc', 'pseudo-discord', 'hyping', 'zelda', 
        'style', 'description', 'initiative', 'specialite', 'attentes'
    ];
    
    let isValid = true;
    let firstErrorField = null;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.style.borderColor = '#f44336';
            if (!firstErrorField) firstErrorField = field;
            isValid = false;
        } else {
            field.style.borderColor = '';
        }
    });
    
    if (!isValid && firstErrorField) {
        firstErrorField.focus();
        showMessage('Veuillez remplir tous les champs obligatoires.', 'error');
    }
    
    return isValid;
}

// Validation de la partie 2
function validatePart2() {
    const requiredFields = [
        'stuff', 'prestige', 'temps-jeu', 'attentes-ob', 
        'installation', 'confiance', 'teleportation'
    ];
    
    let isValid = true;
    let firstErrorField = null;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            if (fieldId !== 'temps-jeu') {
                field.style.borderColor = '#f44336';
            }
            if (!firstErrorField) firstErrorField = field;
            isValid = false;
        } else {
            if (fieldId !== 'temps-jeu') {
                field.style.borderColor = '';
            }
        }
    });
    
    // Vérification spéciale pour les créneaux horaires
    if (selectedTimeSlots.size === 0) {
        showMessage('Veuillez sélectionner au moins un créneau horaire.', 'error');
        return false;
    }
    
    if (!isValid && firstErrorField) {
        firstErrorField.focus();
        showMessage('Veuillez remplir tous les champs obligatoires.', 'error');
    }
    
    return isValid;
}

// Afficher une partie spécifique
function showPart(partNumber) {
    // Masquer toutes les parties
    document.querySelectorAll('.form-part').forEach(part => {
        part.classList.remove('active');
    });
    
    // Afficher la partie demandée
    document.getElementById(`part${partNumber}`).classList.add('active');
    
    // Mettre à jour la barre de progression
    updateProgress(partNumber);
    
    // Faire défiler vers le haut
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    currentPart = partNumber;
}

// Mettre à jour la barre de progression
function updateProgress(partNumber) {
    const progressText = document.getElementById('progress-text');
    const progressFill = document.getElementById('progress-fill');
    
    progressText.textContent = `Partie ${partNumber} sur 2`;
    progressFill.style.width = `${(partNumber / 2) * 100}%`;
}

// Initialisation du formulaire
function initializeForm() {
    // Rien de spécial à initialiser pour le moment
    console.log('Formulaire initialisé');
}

// Soumission du formulaire
function submitForm() {
    const form = document.getElementById('recruitment-form');
    const formData = new FormData(form);
    
    // Afficher le message de chargement
    showMessage('Envoi de votre candidature en cours...', 'loading');
    
    // Convertir FormData en objet simple
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Simulation d'envoi (remplacez par votre logique d'envoi réelle)
    setTimeout(() => {
        // Simuler un succès
        showMessage('Candidature envoyée avec succès ! Nous vous contacterons bientôt.', 'success');
        
        // Optionnel : réinitialiser le formulaire après quelques secondes
        setTimeout(() => {
            form.reset();
            selectedTimeSlots.clear();
            updateCalendarSummary();
            showPart(1);
        }, 3000);
    }, 2000);
}

// Afficher un message de statut
function showMessage(message, type) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.style.display = 'block';
    statusDiv.className = `${type}-message`;
    statusDiv.textContent = message;
    
    // Faire défiler vers le message
    statusDiv.scrollIntoView({ behavior: 'smooth' });
}
